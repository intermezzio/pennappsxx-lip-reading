<html>
<head>
<title>Lip Reading</title>
<!-- Materialize CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- Regular CSS -->
<link rel="stylesheet" type="text/css" href="flask.css">
</head>
<body>

<div id="container">
  <nav>
    <div class="nav-wrapper orange lighten-1">
      <a href="#" class="brand-logo">Logo</a>
      <ul id="nav-mobile" class="right hide-on-med-and-down">
        <li><a href="#">Film</a></li>
        <li><a href="#">Transcript</a></li>
        <li><a href="#">About</a></li>
      </ul>
    </div>
  </nav>
  <input type="file" hidden id="toFlask">
  <div class="row">
    <button hidden type="submit" id = "go"></button>
    <div class="col s3" id="video-buttons">
      <a class="waves-effect waves-light btn" id='request'>Request Camera<i class="material-icons right">camera_alt</i></a>
      <a class="waves-effect waves-light btn" id='start' onclick='startRecording()'>Start Recording<i class="material-icons right">videocam</i></a>
      <a class="waves-effect waves-light btn" id='stop' onclick='stopRecording()' hidden>Stop Recording<i class="material-icons right">videocam_off</i></a>
    </div>
    <!--   <button id='start' class='btn' onclick = "startRecording()">
      Start Recording <i class="material-icons right">videocam</i>
    </button>
    <button id='stop' class='btn' onclick = "stopRecording()" hidden>
      Stop Recording <i class="material-icons right">videocam_off</i>
    </button> -->
    <video id='video' autoplay></video>
    <div id='transcript'>
      Transcript:
      <br /><span id='transcript-txt'></span>
    </div>
    <ul id='ul'>
      Downloads List:
    </ul>
  </div>
</div>
<!-- Materialize JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script type="text/javascript" src="flask.js"></script>
<script type = "text/javascript">
var video, reqBtn, startBtn, stopBtn, ul, stream, recorder, timer;
video = document.getElementById('video');
reqBtn = document.getElementById('request');
startBtn = document.getElementById('start');
stopBtn = document.getElementById('stop');
ul = document.getElementById('ul');
reqBtn.onclick = requestVideo;
startBtn.onclick = startRecording;
stopBtn.onclick = stopRecording;
startBtn.disabled = true;
ul.style.display = 'none';
stopBtn.disabled = true;

function requestVideo() {
  navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    })
    .then(stm => {
      stream = stm;
      reqBtn.style.display = 'none';
      startBtn.removeAttribute('disabled');
    }).catch(e => console.error(e));
}

function startRecording() {
  recorder = new MediaRecorder(stream, {audioBitsPerSecond: 0});
  recorder.start();
  video.srcObject = stream; 
  stopBtn.removeAttribute('disabled');
  startBtn.disabled = true;
  setTimeout(sendNew, 3000)
  
}

function sendNew(){
  recorder.ondataavailable = e => {
    ul.style.display = 'block';
    var a = document.createElement('a'),
      li = document.createElement('li');
    a.download = ['video_', (new Date() + '').slice(4, 28), '.webm'].join('');
    a.href = URL.createObjectURL(e.data);
    a.textContent = a.download;

    var formData = new FormData();
    formData.append('clip', e.data, a.download);
    console.log(typeof(e.data));
    var request = new XMLHttpRequest();
    request.open("POST", "http://127.0.0.1:5000/form");
    request.onload = function() {
      console.log(this.responseText);
    }
    request.send(formData);

    li.appendChild(a);
    ul.appendChild(li);
  };
  recorder.stop();
  recorder.start();
  timer = setTimeout(sendNew, 3000)
}

function stopRecording() {
  recorder.ondataavailable = e => {
    ul.style.display = 'block';
    var a = document.createElement('a'),
      li = document.createElement('li');
    a.download = ['video_', (new Date() + '').slice(4, 28), '.webm'].join('');
    a.href = URL.createObjectURL(e.data);
    a.textContent = a.download;
    li.appendChild(a);
    ul.appendChild(li);

    var formData = new FormData();
    formData.append('clip', e.data, a.download);
    console.log(typeof(e.data));
    var request = new XMLHttpRequest();
    request.open("POST", "http://127.0.0.1:5000/form");
    request.onload = function() {
      console.log(this.responseText);
    }
    request.send(formData);
  };
  recorder.stop();
  if(timer) {
    clearTimeout(timer);
    timer = 0;
  }
  video.srcObject = null; 
  stopBtn.removeAttribute('disabled');
  startBtn.removeAttribute('disabled');
  stopBtn.disabled = true;
}
</script>

</body>
</html>
