<html>
<body>
<div>
  <form name = "sub" onSubmit="/* tellMe();return false */" method="post">
  <!--<form onSubmit="return false">-->
  <input type="file" hidden id="toFlask">
  </input>
  <button hidden type="submit" id = "go"></button>
  </form>
  <button id='request'>
    Request Camera
  </button>
  <button id='start' onclick = "startRecording()">
    Start Recording
  </button>
  <button id='stop' onclick = "stopRecording()">
    Stop Recording
  </button>
  <ul id='ul'>
    Downloads List:
  </ul>

</div>
<video id='video' autoplay></video>
<script type = "text/javascript">
var video, reqBtn, startBtn, stopBtn, ul, stream, recorder;
video = document.getElementById('video');
reqBtn = document.getElementById('request');
startBtn = document.getElementById('start');
stopBtn = document.getElementById('stop');
ul = document.getElementById('ul');
reqBtn.onclick = requestVideo;
startBtn.onclick = startRecording;
stopBtn.onclick = stopRecording;
startBtn.disabled = true;
ul.style.display = 'none';
stopBtn.disabled = true;

function requestVideo() {
  navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    })
    .then(stm => {
      stream = stm;
      reqBtn.style.display = 'none';
      startBtn.removeAttribute('disabled');
    }).catch(e => console.error(e));
}

//function tellMe(){
//  $('form[name=sub]').submit(function(){
//    $.post($(this).attr('action'), $(this).serialize(), function(json) {
//      alert(json);
//    }, 'json');
//    return false;
//  });
//}

function startRecording() {
  recorder = new MediaRecorder(stream);
  recorder.start();
  video.srcObject = stream; 
  stopBtn.removeAttribute('disabled');
  startBtn.disabled = true;
  setTimeout(sendNew, 3000)
}

function sendNew(){
  recorder.ondataavailable = e => {
    ul.style.display = 'block';
    var a = document.createElement('a'),
      li = document.createElement('li');
    a.download = ['video_', (new Date() + '').slice(4, 28), '.webm'].join('');
    a.href = URL.createObjectURL(e.data);
    a.textContent = a.download;

    // something
    var formData = new FormData();
    formData.append('clip', e.data, a.download);
    console.log(typeof(e.data));
    // formData.append('filename', a.download);
    var request = new XMLHttpRequest();
    request.open("POST", "http://127.0.0.1:5000/form");
    // request.setRequestHeader("Content-Type", "multipart/form-data");
    request.onload = function() {
      console.log(this.responseText);
    }
    request.send(formData);

    li.appendChild(a);
    ul.appendChild(li);
    // filesub = document.getElementById('toFlask');
    // document.getElementById('go').click(); 
  };
  recorder.stop();
  recorder.start();
  setTimeout(sendNew, 3000)
}

function stopRecording() {
  recorder.ondataavailable = e => {
    ul.style.display = 'block';
    var a = document.createElement('a'),
      li = document.createElement('li');
    a.download = ['video_', (new Date() + '').slice(4, 28), '.webm'].join('');
    a.href = URL.createObjectURL(e.data);
    a.textContent = a.download;
    li.appendChild(a);
    ul.appendChild(li);
  };
  recorder.stop();
  startBtn.removeAttribute('disabled');
  stopBtn.disabled = true;
}
</script>

</body>
</html>
